<script>
  const log = document.getElementById('log');
  const form = document.getElementById('form');
  const input = document.getElementById('q');

  function addBubble(role, text) {
    const div = document.createElement('div');
    div.className = 'row ' + (role === 'user' ? 'user' : 'bot');
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  async function askServer(q) {
    try {
      // âœ… Correct use of backticks for template string
      const res  = await fetch(`/api/ask?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      return data.answer ?? data.error ?? "Sorry, I couldn't find an answer.";
    } catch (e) {
      return "Sorry, something went wrong.";
    }
  }

  async function send() {
    const q = (input.value ?? '').trim();
    if (!q) return;
    addBubble('user', q);
    input.value = '';
    const reply = await askServer(q);
    addBubble('bot', reply);
  }

  // Submit with Enter
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    send();
  });

  // Submit with Enter even if Notion steals focus
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      send();
    }
  });

  // Quick chips
  document.querySelectorAll('.chip').forEach(btn => {
    btn.addEventListener('click', () => sendFromChip(btn.dataset.q));
  });

  async function sendFromChip(q) {
    if (!q) return;
    addBubble('user', q);
    input.value = '';
    const reply = await askServer(q);
    addBubble('bot', reply);
  }

  // Optional greeting (no undefined anymore)
  addBubble('bot', 'ðŸ‘‹ Hi! Ask me anything from your Employee Handbook.');
</script>
